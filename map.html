<head>
    <meta charset='utf-8' />
    <title>Hollaback Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src='GPSdata.js'></script>
    <script src='timetravel.js'></script>
    <script src='coolock.js'></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v3.1.1/mapbox-gl-directions.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v3.1.1/mapbox-gl-directions.css' type='text/css' />
    <link rel='stylesheet' href='map.css' type='text/css' />
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>
<body>
<div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="reportModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reportModalLabel">Report</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <p>Submit your issue here.</p>
          <label id='issueLabel' for='issue'>Issue:</label><input id='issue' type='text' placeholder='Garbage not picked up'><br>
          <label id='locationLabel' for='location'>Location:</label><input id='location' type='text' placeholder='50 Main St Schenectady, NY'>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary">Submit</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="wrapper">
  <input type="checkbox" id="navigationCB"/>
  <label for="navigationCB" class="navButton">
    &#11166;
  </label>
  <nav>
    <ul>
      <a href='http://www.cityofschenectady.com/list.aspx' target='_blank'><li>Notifications</li></a>
      <a href='http://cityofschenectady.com/531/Waste-Collection-Schedules' target='_blank'><li>District Schedules</li></a>
      <a href='https://www.waze.com/ccp' target='_blank'><li>Waze CCP</li></a>
      <a data-toggle="modal" href='#reportModal'><li>Submit Report</li></a>
    </ul>
  </nav>
  <div class="autocomplete">
    <input id='addressinput' name='addressinput' type="text" placeholder="Address.." />
    <span id='arrivalTimeLbl'>Estimated Arrival Time: </span><span id="arrival_time"></span>
  </div>
  <div id='map'></div>
    <div id="LayerButtons"></div>
    <a id='clocks' href='#'><div id="coolockWrapper">
      <label id="clockLabel">00:00 AM</label>
    </div></a>
  </div>
</div>
<script>

var vehicleIDs = Object.keys(GPSdata);


var clock = Timetravel.Clock({time: 39600000, speed: 75});
var coolock = new Coolock({size: 100});

function compareTimes(date1, date2)
{
  if (date1.getHours() > date2.getHours())
    return true;
  if (date1.getHours() < date2.getHours())
    return false;
  if (date1.getMinutes() > date2.getMinutes())
    return true;
  if (date1.getMinutes() < date2.getMinutes())
    return false;
  if (date1.getSeconds() > date2.getSeconds())
    return true;
  if (date1.getSeconds() < date2.getSeconds())
    return false;

  return true;
}

$('#clocks').on('click', function() {
  if (clock.isStopped()) {
    clock.start();
  } else {
    clock.stop();
  }
});

mapboxgl.accessToken = 'pk.eyJ1IjoiY293YW5nNCIsImEiOiJjamRodHYxZHAxMHF3MnBvMWM4cmF0Y29vIn0.g8Wb-swsy8VeQOISY8iOgw';

var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v9?optimize=true',
  center: [-73.9409, 42.8144],
  zoom: 3
});

function ease() {
  let duration = location.href.includes("refresh");
  map.easeTo({bearing:0, duration: duration ? 0 : 5000, pitch:50, zoom:13});
}

function animateTruck(truckID, newCoords, fraction) {
  let x = newCoords[0][0] + (newCoords[newCoords.length - 1][0] - newCoords[0][0]) * fraction;
  let y = newCoords[0][1] + (newCoords[newCoords.length - 1][1] - newCoords[0][1]) * fraction;
  map.getSource(truckID).setData({
    "type": "FeatureCollection",
    "features": [{
        "type": "Feature",
        "geometry": {
            "type": "Point",
            "coordinates": [x, y]
        }
    }]
  });

  if (fraction < 1)
  {
    window.requestAnimationFrame(() => {
      animateTruck(truckID, newCoords, fraction + .2);
    });
  }

}

var clock_label = $('#clockLabel');

function line() {
  const colors = ["#ff0000", "#ff6f00", "#ffdd00", "#b2ff00", "#44ff00", "#00ff2b", "#00ff99", "#00f7ff", "#0088ff", "#0019ff", "#5500ff", "#c400ff", "#ff00cc", "#ff005e"];
  let i = 0;
  for (let i = 0; i < vehicleIDs.length; i++)
  {
    let vehicleID = vehicleIDs[i];
    let events = GPSdata[vehicleIDs[i]];
    let color = colors[i];
    let coords = [];
    for (let vehicleEvent of events)
      coords.push([vehicleEvent.Longitude, vehicleEvent.Latitude]);

    map.addLayer({
      "id": vehicleID,
      "type": "line",
      "source": {
          "type": "geojson",
          "data": {
              "type": "Feature",
              "properties": {},
              "geometry": {
                  "type": "LineString",
                  "coordinates": coords
              }
          }
      },
      "layout": {
          "line-join": "round",
          "line-cap": "round"
      },
      "paint": {
          "line-color": color,
          "line-width": 8,
          "line-dasharray": [.01, 3],
          "line-opacity": .5
      }
    });

    map.addLayer({
      "id": vehicleID + "driven",
      "type": "line",
      "source": {
          "type": "geojson",
          "data": {
              "type": "Feature",
              "properties": {},
              "geometry": {
                  "type": "LineString",
                  "coordinates": []
              }
          }
      },
      "layout": {
          "line-join": "round",
          "line-cap": "round"
      },
      "paint": {
          "line-color": color,
          "line-width": 8
      }
    });

    map.addLayer(
      {
        "id": vehicleID + "truck",
        "source": {
            "type": "geojson",
            "data":
            {
              "type": "FeatureCollection",
              "features": [{
                  "type": "Feature",
                  "geometry": {
                      "type": "Point",
                      "coordinates": coords[0]
                  }
              }]
            }
          },
        "type": "symbol",
        "layout": {
          "icon-image": "garbagetruck",
          "icon-allow-overlap": true,
          "icon-size": 0.25,
          "icon-keep-upright": true
        }
      });

    // timed loop for updating truck progress
    // loops are staggered for each line so that they update at separate times
    const timeStagger = 25;
    let dataIndex = 0;
    let lineUpdate = () =>
    {
      if (clock.time() >= 60000000)
      {
        if (!location.href.includes("refresh"))
          location.href = location.href + "?refresh"
        else
          location.reload(true);


      }

      if (dataIndex === events.length - 1)
      {
        dataIndex = 0;
        map.getSource(vehicleID + "driven").setData(
          {
              "type": "Feature",
              "properties": {},
              "geometry": {
                  "type": "LineString",
                  "coordinates": []
              }
          }
        );

        map.getSource(vehicleID).setData({
          "type": "FeatureCollection",
          "features": [{
              "type": "Feature",
              "geometry": {
                  "type": "Point",
                  "coordinates": coords[0]
              }
          }]
        });
      }
      else
      {
        let startingIndex = dataIndex;
        let update = false;
        let currentTime = new Date(clock.time());
        let eventTime = new Date(events[dataIndex].StartTime);
        while (dataIndex < events.length - 1 && compareTimes(currentTime, eventTime))
        {
          dataIndex++;
          eventTime = new Date(events[dataIndex].StartTime)
          update = true;
        }

        if (update)
        {
          let drivenCoords = coords.slice(0, dataIndex);

          map.getSource(vehicleID + "driven").setData(
            {
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "type": "LineString",
                    "coordinates": drivenCoords
                }
            }
          );

          animateTruck(vehicleID + "truck", coords.slice(startingIndex, dataIndex + 1), 0);
        }

        clock_label.html(str_time(currentTime));

      }

      window.setTimeout(lineUpdate, vehicleIDs.length * timeStagger);
    };

    window.setTimeout(lineUpdate, i * timeStagger);
  }

  // Move all trucks to the top!
  for (let i = vehicleIDs.length - 1; i >= 0; i--)
  {
    map.moveLayer(vehicleIDs[i] + "truck");
  }
}

function buildings() {
  // Insert the layer beneath any symbol layer.
  var layers = map.getStyle().layers;

  var labelLayerId;
  for (var i = 0; i < layers.length; i++) {
      if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
          labelLayerId = layers[i].id;
          break;
      }
  }

  map.addLayer({
      'id': '3d-buildings',
      'source': 'composite',
      'source-layer': 'building',
      'filter': ['==', 'extrude', 'true'],
      'type': 'fill-extrusion',
      'minzoom': 15,
      'paint': {
          'fill-extrusion-color': '#aaa',

          // use an 'interpolate' expression to add a smooth transition effect to the
          // buildings as the user zooms in
          'fi1l-extrusion-height': [
              "interpolate", ["linear"], ["zoom"],
              15, 0,
              15.05, ["get", "height"]
          ],
          'fill-extrusion-base': [
              "interpolate", ["linear"], ["zoom"],
              15, 0,
              15.05, ["get", "min_height"]
          ],
          'fill-extrusion-opacity': .6
      }
  }, labelLayerId);
}

map.on('load', function(){
  ease();
  map.loadImage('https://i.imgur.com/SLeKDw1.png', (error, image) => {
    console.log(error);
    map.addImage('garbagetruck', image);
    line();
  });
  buttons();

})

var allEvents = [];
let locationSet = new Set();
for (let i = 0; i < vehicleIDs.length; i++)
{
  for (let oneEvent of GPSdata[vehicleIDs[i]])
  {
    if (locationSet.has(oneEvent.Location))
    continue;

    allEvents.push(oneEvent);
    locationSet.add(oneEvent.Location);
  }
}

$("#addressinput").autocomplete({
  minLength: 1,
  source: function(request, response) {
    var term = request.term;
    var matches = allEvents.filter(evnt => evnt.Location.toLowerCase().includes(term.toLowerCase()));
    var result = matches.map(x => x.Location);
    response(result);
  },
});

var address_event = null;

function str_time(time) {
  var str = ('0'+(time.getHours() > 12 ? time.getHours()%12 : time.getHours())).slice(-2);
  str += ':'+('0'+time.getMinutes()).slice(-2);
  str += time.getHours() > 11 ? ' PM' : ' AM';
  return str;
}

$("#addressinput").on("autocompleteselect", function(event, ui) {
  var val = ui.item.value;
  address_event = allEvents.filter(evnt => evnt.Location == val)[0];
  var time = new Date(Date.parse(address_event.StartTime));
  $('#arrival_time').html(str_time(time));

  map.setCenter([address_event.Longitude, address_event.Latitude]);

  var current_time = new Date(clock.time());
  var v_id = address_event.VehicleID;
  var route = GPSdata[v_id];
  var most_recent = route.filter(evnt => new Date(evnt.StartTime) > current_time)[0];
  var traffic_time = null;
  var direct_time = null;
  var promises = [$.ajax({
    method: 'GET',
    url: `https://api.mapbox.com/directions/v5/mapbox/driving-traffic/${most_recent.Longitude},${most_recent.Latitude};${address_event.Longitude},${address_event.Latitude}`,
    data: {
      access_token: mapboxgl.accessToken,
      overview: 'full',
      annotations: 'duration,congestion'
    },
    dataType: 'json',
    error: function(xhr, tstatus, error) {
      console.log(error);
      console.log(tstatus);
      console.log(xhr);
    }
  }).then((data, tstatus, xhr) => {
    traffic_time = data.routes[0].legs[0].annotation.duration.reduce((a, b)=>a + b, 0);
  }),
  $.ajax({
    method: 'GET',
    url: `https://api.mapbox.com/directions/v5/mapbox/driving/${most_recent.Longitude},${most_recent.Latitude};${address_event.Longitude},${address_event.Latitude}`,
    data: {
      access_token: mapboxgl.accessToken,
      overview: 'full',
      annotations: 'duration,congestion'
    },
    dataType: 'json',
    error: function(xhr, tstatus, error) {
      console.log(error);
      console.log(tstatus);
      console.log(xhr);
    }
  }).then((data, tstatus, xhr) => {
    direct_time = data.routes[0].legs[0].annotation.duration.reduce((a, b)=>a + b, 0);
  })];

  Promise.all(promises).then(() => {
    var delay_time = traffic_time - direct_time;
    time.setSeconds(time.getSeconds()+delay_time);
    if (time.getHours() >= 12) {
      $('#arrival_time').html(('0'+time.getHours()).slice(-2)+':'+('0'+time.getMinutes()).slice(-2)+' PM');
    }
    else {
      $('#arrival_time').html(('0'+time.getHours()).slice(-2)+':'+('0'+time.getMinutes()).slice(-2)+' AM');
    }

    $('#arrival_time')[0].style.display = "block";
    $('#arrivalTimeLbl')[0].style.display = "block";
  });
});

function buttons() {
  // Add toggleable layer buttons
  let layerButtons = document.getElementById("LayerButtons");
  for (let vehicleID of vehicleIDs)
  {
    let button = document.createElement("button");
    button.type = "button";
    button.classList.add("layerButton");
    button.textContent = vehicleID;

    button.addEventListener("click", (evt) => {
      let layerID = button.textContent;
      evt.preventDefault();
      if (button.classList.contains("enabled"))
      {
        button.classList.remove("enabled");
      }
      else
      {
        button.classList.add("enabled");
        map.setLayoutProperty(layerID, "visibility", "visible");
        map.setLayoutProperty(layerID + "driven", "visibility", "visible");
        map.setLayoutProperty(layerID + "truck", "visibility", "visible");
      }
      if ($('button.layerButton.enabled').length > 0) {
        $('button.layerButton').each(function(index, element) {
          if (!$(this).hasClass('enabled')) {
            map.setLayoutProperty(element.textContent, "visibility", "none");
            map.setLayoutProperty(element.textContent + "driven", "visibility", "none");
            map.setLayoutProperty(element.textContent + "truck", "visibility", "none");
          }
        });
      } else {
        for (let vehicleID of vehicleIDs) {
          map.setLayoutProperty(vehicleID, "visibility", "visible");
          map.setLayoutProperty(vehicleID + "driven", "visibility", "visible");
          map.setLayoutProperty(vehicleID + "truck", "visibility", "visible");
        }
      }
    });

    button.addEventListener("mouseenter", (evt) => {
      let layerID = button.textContent;
      evt.preventDefault();
      map.setLayoutProperty(layerID, "visibility", "visible");
      map.setLayoutProperty(layerID + "driven", "visibility", "visible");
      map.setLayoutProperty(layerID + "truck", "visibility", "visible");

      for (let vehicleID of vehicleIDs)
      {
        if (vehicleID != layerID)
        {
          map.setPaintProperty(vehicleID, "line-opacity", 0.05);
          map.setPaintProperty(vehicleID + "driven", "line-opacity", 0.05)
          map.setPaintProperty(vehicleID + "truck", "icon-opacity", 0.05)
        }
        else
        {
          map.moveLayer(vehicleID, vehicleIDs[0] + "truck");
          map.moveLayer(vehicleID + "driven", vehicleIDs[0] + "truck");
          // Move all trucks to the top!
          for (let i = vehicleIDs.length - 1; i >= 0; i--)
          {
            map.moveLayer(vehicleIDs[i] + "truck");
          }
        }
      }
    });

    button.addEventListener("mouseleave", (evt) => {
      let layerID = button.textContent;
      evt.preventDefault();
      if ($('button.layerButton.enabled').length > 0 && !$(button).hasClass('enabled')) {
        map.setLayoutProperty(layerID, "visibility", "none");
        map.setLayoutProperty(layerID + "driven", "visibility", "none");
        map.setLayoutProperty(vehicleID + "truck", "visibility", "none");
      }
      for (let vehicleID of vehicleIDs)
      {
        if (vehicleID != layerID)
        {
          map.setPaintProperty(vehicleID, "line-opacity", .5);
          map.setPaintProperty(vehicleID + "driven", "line-opacity", 1)
          map.setPaintProperty(vehicleID + "truck", "icon-opacity", 1)
        }
      }
    });

    layerButtons.appendChild(button);
  }
}

$('#navigationCB').click(function() {
  if ($(this)[0].checked == true) {
    $('label.navButton').html('&#11164;');
  }
  else {
    $('label.navButton').html('&#11166;');
  }
});

function handleVisibilityChange() {
  if (document.hidden) {
    clock.stop();
  } else  {
    clock.start();
  }
}

document.addEventListener("visibilitychange", handleVisibilityChange, false);

</script>

</body>
</html>
